<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
  <link rel="manifest" href="manifest.json"/>
  <title>ç”Ÿå§œç»è¥è®¡ç®—å™¨</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 10px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 12px;
      border-radius: 12px;
      box-shadow: none;
    }
    .header {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      position: relative;
      gap: 10px;
      width: 100%;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin: 0;
      font-size: 18px;
      flex: 1;
    }
    .input-section {
      margin-bottom: 12px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      color: #34495e;
      font-weight: 600;
      font-size: 13px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      height: 36px;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
    }
    .explanation {
      margin: 10px 0;
      padding: 10px;
      background: #ecf0f1;
      border-radius: 6px;
      color: #7f8c8d;
      font-size: 13px;
      display: block;
      opacity: 1 !important;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .result-item {
      margin: 8px 0;
      padding: 8px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      font-size: 13px;
      line-height: 1.5;
    }
    .result-item strong {
      font-weight: 600;
      color: #2c3e50;
      display: inline-block;
      margin-right: 4px;
    }
    .hidden {
      display: none;
    }
    .radio-group {
      margin: 0;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
      font-weight: normal;
      cursor: pointer;
      font-size: 14px;
      padding: 8px 0;
    }
    .result-section {
      margin-top: 15px;
      padding: 10px;
      background: #ecf0f1;
      border-radius: 6px;
    }
    .result-section h4 {
      margin: 0 0 8px;
      color: #2c3e50;
      font-size: 15px;
    }
    .hint {
      color: #7f8c8d;
      font-size: 12px;
      margin-left: 8px;
      font-weight: normal;
      display: inline-block;
    }
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      .container {
        padding: 8px;
        margin: 0;
        box-shadow: none;
      }
      h1 {
        font-size: 16px;
        margin: 0;
        text-align: center;
      }
      .input-section {
        margin-bottom: 15px;
        padding: 12px;
      }
      input, select {
        padding: 8px;
        font-size: 14px;
      }
      button {
        padding: 10px;
        font-size: 15px;
      }
      .header {
        padding: 0 5px;
      }
      .control-buttons {
        gap: 8px;
      }
      .control-btn {
        height: 32px;
        padding: 0 10px;
        font-size: 13px;
        width: 70px;
      }
      .control-btn .btn-icon {
        font-size: 16px;
        margin-right: 4px;
      }
      .result-item {
        padding: 8px;
        font-size: 13px;
      }
      .formula-hint {
        font-size: 12px;
        margin-left: 8px;
        padding: 4px 6px;
      }
      .button-group {
        gap: 6px;
      }
      #calculate-btn, #copy-btn {
        height: 40px;
        font-size: 14px;
      }
      .copy-success {
        font-size: 13px;
        padding: 8px 16px;
      }
    }
    /* æ·»åŠ åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .mode-toggle {
      position: static;
      margin-left: 20px;
    }
    .mode-toggle button {
      padding: 8px 12px;
      font-size: 14px;
      background: #f0f0f0;
      color: #333;
      border-radius: 20px;
      border: 1px solid #ddd;
    }

    /* å…¬å¼è¯´æ˜æ ·å¼ */
    .formula-hint {
      color: #2ecc71;
      font-size: 0.85em;
      margin: 3px 0 0 5px;
      padding-left: 8px;
      border-left: 3px solid #3498db;
    }
    
    /* æŒ‰é’®çŠ¶æ€æŒ‡ç¤º */
    .active-mode {
      background: #3498db !important;
      color: white !important;
    }

    /* å¢å¼ºè¯´æ˜æ ·å¼ */
    .detail-hint {
      color: #3498db;
      font-size: 0.9em;
      margin: 5px 0 0 10px;
      padding: 4px 8px;
      background: #f0f8ff;
      border-radius: 4px;
      display: inline-block;
    }

    /* ä¼˜åŒ–å…¬å¼æ˜¾ç¤º */
    .formula-hint {
      background: #f8fff0;
      padding: 6px 10px;
      margin: 5px 0 0 15px;
      border-left: 3px solid #2ecc71;
    }

    .detail-mode .explanation {
      display: none;
    }

    /* ä¿®å¤æ ·å¼å†²çª */
    .explanation {
      opacity: 1 !important;
    }

    /* æ·»åŠ é—ªçƒåŠ¨ç”» */
    @keyframes blink {
      50% { opacity: 0.5; }
    }
    .blink {
      animation: blink 1s ease-in-out infinite;
      color: #e74c3c;
      margin-left: 5px;
    }

    /* å¼ºåˆ¶è¦†ç›–å…¬å¼è¯´æ˜çš„æ˜¾ç¤º */
    .formula-hint {
      display: none;
    }
    .detail-mode .formula-hint {
      display: block;
    }

    /* æ·»åŠ è®¾ç½®é¢æ¿æ ·å¼ */
    .settings-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(0,0,0,0.2);
      z-index: 1000;
      max-width: 500px;
      width: 90%;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .settings-header h3 {
      margin: 0;
      font-size: 18px;
      color: #2c3e50;
    }

    .settings-tabs {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .tab-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 20px;
      background: #f8f9fa;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }

    .settings-section {
      display: none;
      padding: 15px 0;
    }

    .settings-section.active {
      display: block;
    }

    .settings-section h4 {
      margin: 0 0 15px;
      color: #2c3e50;
      font-size: 16px;
    }

    .setting-item {
      margin-bottom: 15px;
    }

    .setting-item label {
      display: block;
      margin-bottom: 8px;
      color: #34495e;
      font-size: 14px;
    }

    .setting-item input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .settings-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .header-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .settings-btn {
      padding: 8px 15px !important;
      background: #f8f9fa !important;
      border: 1px solid #ddd !important;
      border-radius: 20px !important;
      transition: all 0.3s ease;
    }

    .settings-btn:hover {
      background: #e9ecef !important;
      transform: scale(1.05);
    }

    .settings-footer button {
      padding: 8px 20px;
      border-radius: 20px;
      background: #3498db;
      color: white;
      border: none;
      transition: all 0.3s ease;
    }

    .settings-footer button:hover {
      background: #2980b9;
      transform: scale(1.05);
    }

    .button-group {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    #calculate-btn {
      flex: 1;
    }

    #copy-btn {
      flex: 0 0 120px;
      background: #2ecc71;
      display: none; /* ä½¿ç”¨å†…è”æ ·å¼æ§åˆ¶ */
    }

    #copy-btn.visible {
      display: block;
    }

    /* æ·»åŠ æç¤ºåŠ¨ç”» */
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .copy-success {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #2ecc71;
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      animation: fadeOut 1.5s ease-in-out forwards;
      z-index: 1000;
    }

    /* æ§åˆ¶æŒ‰é’®ç»„æ ·å¼ */
    .control-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      width: auto;
      order: 2; /* è®¾ç½®æŒ‰é’®æ”¾åœ¨å³è¾¹ */
    }
    
    .control-btn {
      min-width: 80px;
      max-width: 120px;
      width: calc(15vw - 20px); /* æ ¹æ®è§†çª—å®½åº¦åŠ¨æ€è°ƒæ•´æŒ‰é’®å®½åº¦ */
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 20px;
      border: 1px solid #e0e0e0;
      background: white;
      color: #333;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .control-btn .btn-icon {
      font-size: 16px;
      margin-right: 2px;
      flex-shrink: 0;
    }
    
    .control-btn.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(52, 152, 219, 0.2);
    }
    
    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 480px) {
      .control-buttons {
        gap: 8px;
      }
      
      .control-btn {
        min-width: 60px;
        max-width: 90px;
        width: calc(20vw - 10px);
        height: 36px;
        padding: 0 8px;
        font-size: 12px;
      }
      
      .control-btn .btn-icon {
        font-size: 14px;
        margin-right: 1px;
      }
      
      h1 {
        margin-bottom: 0 !important; /* ç§»é™¤æ ‡é¢˜åº•éƒ¨é—´è· */
      }
    }

    /* è¶…å°å±å¹•é€‚é… */
    @media (max-width: 360px) {
      .control-btn {
        min-width: 50px;
        max-width: 70px;
        width: calc(25vw - 10px);
        padding: 0 6px;
      }
      
      .control-btn .btn-icon {
        margin-right: 1px;
      }
    }

    /* æ·»åŠ è§¦æ‘¸ä¼˜åŒ– */
    @media (hover: none) {
      input, select, button {
        -webkit-tap-highlight-color: transparent;
      }
      .control-btn:active,
      button:active {
        opacity: 0.7;
      }
      .radio-group label {
        padding: 8px 0;
      }
    }

    /* ä¼˜åŒ–é”®ç›˜å¼¹å‡ºæ—¶çš„å¸ƒå±€ */
    @media (max-height: 600px) {
      .container {
        margin-bottom: 60px;
      }
      .settings-panel {
        max-height: 80vh;
        overflow-y: auto;
      }
    }

    /* ä¼˜åŒ–é”€å”®ç±»å‹é€‰æ‹©å¸ƒå±€ */
    .sale-type-container {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 5px 0;
    }

    .sale-type-label {
      margin: 0 !important;
      white-space: nowrap;
      width: 120px;
      text-align: left;
      flex-shrink: 0;
    }

    /* ä¼˜åŒ–é€‰æ‹©æ¨¡å¼å¸ƒå±€ */
    .mode-select-container {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 5px 0;
    }

    .mode-select-label {
      margin: 0 !important;
      white-space: nowrap;
      width: 120px;
      text-align: left;
      flex-shrink: 0;
    }

    /* ä¼˜åŒ–è¾“å…¥æ¡†å¸ƒå±€ */
    .input-group {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 10px 0;
    }

    .input-group label {
      margin: 0;
      white-space: nowrap;
      width: 120px;
      text-align: left;
      flex-shrink: 0;
      font-size: 13px;
      color: #34495e;
    }

    .input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 120px;
      max-width: 100%;
      height: 36px;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .input-wrapper input,
    .input-wrapper select {
      flex: 1;
      min-width: 120px;
      max-width: 100%;
      height: 36px;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .detail-hint {
      margin: 0;
      white-space: nowrap;
      font-size: 12px;
      color: #3498db;
      flex-shrink: 0;
      text-align: left;
      width: auto;
      min-width: 150px;
    }

    /* ä¼˜åŒ–æ ‡é¢˜æ ·å¼ */
    .result-section h4 {
      margin: 0 0 12px;
      color: #2c3e50;
      font-size: 15px;
      font-weight: 600;
    }

    /* ä¼˜åŒ–é«˜äº®é¡¹æ ·å¼ */
    .result-item.highlight {
      background: #f8f9fa;
      border-left: 3px solid #3498db;
    }

    /* ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ– */
    @media (max-width: 480px) {
      .input-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      
      .input-wrapper {
        width: 100%;
        flex: 1;
      }
      
      .input-wrapper input,
      .input-wrapper select {
        flex: 1;
      }
      
      .detail-hint {
        font-size: 11px;
        min-width: auto;
      }
      
      .result-item {
        padding: 10px;
      }
      
      .formula-hint {
        margin: 5px 0 0 10px;
        padding: 5px 8px;
      }
    }

    /* åœ¨åŸæœ‰æ ·å¼è¡¨ä¸­æ·»åŠ  */
    .history-btn {
      background: #17a2b8;
      color: white;
      border-color: #17a2b8;
    }

    .history-btn:hover {
      background: #138496;
      border-color: #138496;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(19, 132, 150, 0.3);
    }

    .btn-icon {
      font-size: 16px;
    }

    /* æ·»åŠ å¤é€‰æ¡†æ ·å¼ */
    .copy-options {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 8px;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }
    
    .checkbox-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin: 0;
    }
    
    .checkbox-label span {
      font-size: 14px;
      color: #34495e;
    }

    /* ä¼˜åŒ–è®¾ç½®é¢æ¿æ ·å¼ */
    .settings-panel {
      max-width: 600px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .settings-header {
      position: sticky;
      top: 0;
      background: white;
      padding: 15px 0;
      border-bottom: 1px solid #eee;
      z-index: 2;
    }
    
    .settings-tabs {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      overflow-x: auto;
      padding-bottom: 5px;
      -webkit-overflow-scrolling: touch;
    }
    
    .tab-btn {
      white-space: nowrap;
      padding: 8px 16px;
      font-size: 13px;
      border: none;
      background: #f0f2f5;
      color: #666;
      border-radius: 20px;
    }
    
    .tab-btn.active {
      background: #3498db;
      color: white;
      font-weight: 500;
    }
    
    .settings-section {
      padding: 20px 0;
    }
    
    .settings-section h4 {
      font-size: 15px;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .setting-item {
      margin-bottom: 20px;
      padding: 0 15px;
    }
    
    .setting-item label {
      font-size: 14px;
      color: #34495e;
      margin-bottom: 10px;
    }
    
    .setting-item input[type="number"] {
      height: 40px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
    }
    
    .setting-item input[type="number"]:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
    }
    
    .settings-footer {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 15px 0;
      border-top: 1px solid #eee;
      margin-top: 20px;
    }

    /* æ·»åŠ æ–°çš„æ ·å¼ */
    .switch-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: background-color 0.2s;
    }
    
    .switch-label:hover {
      background: #f0f2f5;
    }
    
    .switch-label > span {
      flex: 1;
      margin-left: 8px;
    }
    
    .switch-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-left: 12px;
      border-left: 1px solid #e0e0e0;
    }
    
    .action-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #666;
    }
    
    .action-label input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }

    /* ä¼˜åŒ–æ˜¾ç¤ºä¸å¤åˆ¶è®¾ç½®æ ·å¼ */
    .switch-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .switch-label {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      transition: all 0.2s ease;
      height: 42px;
    }
    
    .switch-label:hover {
      background: #fff;
      border-color: #3498db;
      box-shadow: 0 2px 4px rgba(52,152,219,0.1);
    }
    
    .switch-label > input[type="checkbox"] {
      width: 36px;
      height: 20px;
      position: relative;
      appearance: none;
      background: #ddd;
      border-radius: 20px;
      transition: all 0.3s;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .switch-label > input[type="checkbox"]:checked {
      background: #3498db;
    }
    
    .switch-label > input[type="checkbox"]::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: all 0.3s;
    }
    
    .switch-label > input[type="checkbox"]:checked::before {
      left: 18px;
    }
    
    .switch-label > span {
      margin: 0 10px;
      font-size: 13px;
      color: #34495e;
      flex: 1;
    }
    
    .switch-actions {
      display: flex;
      align-items: center;
      padding-left: 12px;
      border-left: 1px solid #e0e0e0;
    }
    
    .action-label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .action-label input[type="checkbox"] {
      width: 14px;
      height: 14px;
      margin: 0;
      cursor: pointer;
    }
    
    .action-label span {
      font-size: 12px;
      color: #666;
      user-select: none;
    }
    
    /* ä¼˜åŒ–è®¾ç½®é¡¹æ ‡é¢˜ */
    .setting-item > label {
      font-size: 14px;
      color: #2c3e50;
      font-weight: 500;
      margin-bottom: 12px;
      display: block;
    }
    
    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 480px) {
      .switch-options {
        grid-template-columns: 1fr;
      }
      
      .switch-label {
        padding: 8px 12px;
        height: 38px;
      }
      
      .switch-label > span {
        font-size: 12px;
      }
      
      .action-label span {
        font-size: 11px;
      }
    }

    /* ä¿®æ”¹æ˜¾ç¤ºä¸å¤åˆ¶è®¾ç½®çš„æ ·å¼ */
    .switch-label {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      transition: all 0.2s ease;
      height: 36px;
    }
    
    .switch-label:hover {
      background: #fff;
      border-color: #3498db;
      box-shadow: 0 2px 4px rgba(52,152,219,0.1);
    }
    
    .switch-label > span {
      flex: 1;
      font-size: 13px;
      color: #34495e;
      margin-right: 10px;
      order: -1; /* å°†æ–‡å­—ç§»åˆ°æœ€å·¦è¾¹ */
    }
    
    .switch-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .control-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin: 0;
      cursor: pointer;
    }
    
    .control-group label {
      font-size: 12px;
      color: #666;
      margin: 0;
    }
    
    .switch-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    /* æ·»åŠ æ–°çš„æ ·å¼ */
    .setting-group {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .setting-group h5 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      font-size: 14px;
      font-weight: 600;
    }

    .mud-hint, .clean-hint {
      display: none;
      font-size: 12px;
      color: #3498db;  /* ä¿®æ”¹ä¸ºä¸å…¶ä»–è¾“å…¥æ¡†è¯´æ˜ç›¸åŒçš„é¢œè‰² */
      margin-top: 5px;
    }

    /* æ·»åŠ å…³äºä¿¡æ¯çš„æ ·å¼ */
    .about-info {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      color: #2c3e50;
    }
    
    .about-info p {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .about-info strong {
      color: #3498db;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="control-btn mode-btn" onclick="window.toggleDetailMode()">
        <span class="btn-icon">ğŸ“±</span><span>ç®€æ´</span>
      </button>
      <h1>ç”Ÿå§œç»è¥è®¡ç®—å™¨</h1>
      <div class="header-controls">
        <button class="control-btn history-btn" onclick="window.location.href='history.html'">
          <span class="btn-icon">ğŸ“œ</span><span>å†å²</span>
        </button>
        <button class="control-btn settings-btn" onclick="toggleSettings()">
          <span class="btn-icon">âš™ï¸</span><span>è®¾ç½®</span>
        </button>
      </div>
    </div>
    
    <div class="input-section">
      <div class="mode-select-container">
        <label class="mode-select-label">è®¡ç®—æ¨¡å¼é€‰æ‹©ï¼š</label>
        <select id="calculation-type">
          <option value="profit" selected>åˆ©æ¶¦æ ¸ç®—</option>
          <option value="loss">æŸè€—åˆ†æ</option>
          <option value="sales">é”€å”®æ€»ä»·</option>
        </select>
      </div>

      <div id="mode-explanation" class="explanation" style="display: none;">
        <div id="loss-desc" style="display: none;">
          <p>æŸè€—åˆ†æï¼šè®¡ç®—é‡‡è´­åˆ°é”€å”®çš„æŸè€—æ¯”ä¾‹</p>
        </div>
        <div id="sales-desc" style="display: none;">
          <p>é”€å”®æ€»ä»·ï¼šè®¡ç®—é¢„æœŸé”€å”®æ€»é¢</p>
        </div>
        <div id="profit-desc" style="display: none;">
          <p>åˆ©æ¶¦æ ¸ç®—ï¼šè®¡ç®—æœ€ç»ˆç»è¥åˆ©æ¶¦</p>
        </div>
      </div>
    </div>

    <!-- å…¬å…±è¾“å…¥åŒºåŸŸ -->
    <div class="input-section">
      <div class="sale-type-container">
        <label class="sale-type-label">é”€å”®ç±»å‹é€‰æ‹©ï¼š</label>
        <div class="radio-group">
          <label>
            <input type="radio" name="sale-type" value="mud" checked> æ³¥å§œ
          </label>
          <label>
            <input type="radio" name="sale-type" value="clean"> æ´—å§œ
          </label>
        </div>
      </div>

      <div id="sale-type-explanation" class="explanation" style="display: none;">
        <div id="mud-desc" style="display: none;">
          <p>æ³¥å§œè¯´æ˜ï¼šå¸¦åŒ…è£…é”€å”®ï¼Œæ¯ä»¶æ¯›é‡æŒ‰50æ–¤è®¡ç®—ï¼ˆå«åŒ…è£…ï¼‰</p>
        </div>
        <div id="clean-desc" style="display: none;">
          <p>æ´—å§œè¯´æ˜ï¼šå‡€é‡é”€å”®ï¼Œé”€å”®æ—¶æŒ‰åŠ å·¥åæ‰“åŒ…é‡é‡è®¡ç®—</p>
        </div>
      </div>

      <div class="input-group">
        <label>å‡ºåº“_ç®±ï¼š</label>
        <div class="input-wrapper">
          <input type="number" id="boxes" step="1" placeholder="è¾“å…¥å‡ºåº“æ€»ç®±æ•°" value="">
          <span class="detail-hint">(åŸå§‹é‡‡è´­çš„æ•´ç®±æ•°é‡)</span>
        </div>
      </div>

      <div class="input-group">
        <label>å®é™…å‡ºè´§_ä»¶ï¼š</label>
        <div class="input-wrapper">
          <input type="number" id="processed-boxes" step="1" value="">
          <span class="detail-hint">(å®é™…å®Œæˆé”€å”®çš„åŒ…è£…ä»¶æ•°)</span>
        </div>
      </div>

      <!-- åœ¨æ´—å§œæ¯ä»¶é‡é‡è¾“å…¥é¡¹æ·»åŠ è¯´æ˜ -->
      <div id="common-clean-weight" class="input-group hidden">
        <label>æ´—å§œæ¯ä»¶é‡é‡_æ–¤ï¼š</label>
        <div class="input-wrapper">
          <input type="number" id="clean-weight" step="0.01" placeholder="è¾“å…¥æ´—å§œæ¯ä»¶é‡é‡" value="50">
          <span class="detail-hint">(åŠ å·¥åçš„å‡€é‡ï¼Œä¸å«åŒ…è£…)</span>
        </div>
      </div>
    </div>

    <!-- é”€å”®æ€»ä»·ä¸“å±è¾“å…¥ -->
    <div id="sales-inputs" class="input-section hidden">
      <div class="input-group">
        <label>é”€å”®å•ä»·_å…ƒ/æ–¤ï¼š</label>
        <div class="input-wrapper">
          <input type="number" id="price" step="0.01" value="">
          <span class="detail-hint">(å½“å‰å¸‚åœºé”€å”®ä»·æ ¼)</span>
        </div>
      </div>
    </div>

    <!-- åˆ©æ¶¦æ ¸ç®—ä¸“å±è¾“å…¥ -->
    <div id="profit-inputs" class="input-section hidden">
      <div class="input-group" id="fee-input-group">
        <label for="fee">åŠ å·¥è´¹ç”¨ï¼ˆå…ƒï¼‰</label>
        <div class="input-wrapper">
          <input type="number" id="fee" step="0" value="0">
          <span class="detail-hint mud-hint">(è‡ªåŠ¨è®¡ç®—ï¼šå®é™…å‡ºè´§é‡(å¨) Ã— <span id="current-mud-fee-rate">0</span>å…ƒ/å¨)</span>
          <span class="detail-hint clean-hint">(è‡ªåŠ¨è®¡ç®—ï¼šå®é™…å‡ºè´§é‡(å¨) Ã— <span id="current-clean-fee-rate">0</span>å…ƒ/å¨)</span>
        </div>
      </div>
      
      <div class="input-group">
        <label>æ¯ç®±é‡‡è´­ä»·_å…ƒï¼š</label>
        <div class="input-wrapper">
          <input type="number" id="box-cost" value="155" step="0.01">
          <span class="detail-hint">(å«åŒ…è£…çš„æ•´ç®±é‡‡è´­æˆæœ¬)</span>
        </div>
      </div>
    </div>

    <div class="button-group">
      <button id="calculate-btn" onclick="calculate(); if(!localStorage.getItem('pendingCalculation')) saveCalculationHistory()">å¼€å§‹è®¡ç®—</button>
      <button onclick="copyResults()" id="copy-btn" class="hidden">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    </div>

    <div class="result hidden" id="result-area">
      <h3>è®¡ç®—ç»“æœ</h3>
      <div id="result-content"></div>
    </div>

    <!-- åœ¨æŸè€—åˆ†æç»“æœåŒºåŸŸæ·»åŠ  -->
    <div id="loss-results" class="results hidden">
      <h3>æŸè€—åˆ†æç»“æœ</h3>
      <div class="result-item">
        <strong>æ¯›é‡æŸè€—æ¯”ä¾‹ï¼š</strong>${(grossLoss * 100).toFixed(2)}% 
        <span class="hint">(ä»…æ³¥å§œæ¨¡å¼)</span>
      </div>
      <div class="result-item">
        <strong>æ¯›é‡é‡‡è´­é‡ï¼š</strong>${grossPurchaseTon.toFixed(3)}å¨
        <div class="formula-hint">
          <div>è®¡ç®—å…¬å¼ï¼š</div>
          <div>é‡‡è´­ç®±æ•° Ã— 50æ–¤/ç®± Ã· 2000æ–¤/å¨</div>
          <div>${inputStates.boxes} Ã— 50 Ã· 2000 = ${grossPurchaseTon.toFixed(3)}</div>
        </div>
      </div>
      <div class="result-item">
        <strong>å‡€é‡é‡‡è´­é‡ï¼š</strong>${totalPurchaseTon.toFixed(3)}å¨
        <div class="formula-hint">
          <div>è®¡ç®—å…¬å¼ï¼š</div>
          <div>é‡‡è´­ç®±æ•° Ã— 47.04æ–¤/ç®± Ã· 2000æ–¤/å¨</div>
          <div>${inputStates.boxes} Ã— 47.04 Ã· 2000 = ${totalPurchaseTon.toFixed(3)}</div>
        </div>
      </div>
      <div class="result-item">
        <strong>å®é™…å‡ºè´§é‡ï¼š</strong>${actualTon.toFixed(3)}å¨
        <div class="formula-hint">
          <div>è®¡ç®—å…¬å¼ï¼š</div>
          <div>å®é™…å‡ºè´§ä»¶æ•° Ã— æ¯ä»¶é‡é‡ Ã· 2000æ–¤/å¨</div>
          <div>${processed}ä»¶ Ã— ${unitWeight}æ–¤ Ã· 2000 = ${actualTon.toFixed(3)}</div>
        </div>
      </div>
      <div class="result-item highlight">
        <strong>å‡€é‡æŸè€—æ¯”ä¾‹ï¼š</strong>${loss}%
        <div class="formula-hint">
          <div>è®¡ç®—å…¬å¼ï¼š</div>
          <div>(å‡€é‡é‡‡è´­é‡ - å®é™…å‡ºè´§é‡) Ã· å‡€é‡é‡‡è´­é‡ Ã— 100%</div>
          <div>(${totalPurchaseTon.toFixed(3)} - ${actualTon.toFixed(3)}) Ã· ${totalPurchaseTon.toFixed(3)} Ã— 100% = ${loss}%</div>
        </div>
      </div>
      <div class="result-item">
        <strong>æ¯›é‡æŸè€—æ¯”ä¾‹ï¼š</strong>${(grossLoss * 100).toFixed(2)}% 
        <span class="hint">(ä»…æ³¥å§œæ¨¡å¼)</span>
        <div class="formula-hint">
          <div>è®¡ç®—å…¬å¼ï¼š</div>
          <div>1 - (å®é™…å‡ºè´§ä»¶æ•° Ã· é‡‡è´­ç®±æ•°)</div>
          <div>1 - (${processed} Ã· ${inputStates.boxes}) = ${(grossLoss * 100).toFixed(2)}%</div>
        </div>
      </div>
    </div>

    <!-- åœ¨åˆ©æ¶¦æ ¸ç®—ç»“æœåŒºåŸŸæ·»åŠ  -->
    <div id="profit-results" class="results hidden">
      <h3>åˆ©æ¶¦æ ¸ç®—ç»“æœ</h3>
      <div class="result-item">
        <strong>é‡‡è´­æˆæœ¬ï¼š</strong>Â¥${purchaseCost.toFixed(2)}å…ƒ
        <div class="formula-hint">
          <div>è®¡ç®—å…¬å¼ï¼š</div>
          <div>å‡ºåº“ç®±æ•° Ã— æ¯ç®±é‡‡è´­ä»·æ ¼</div>
          <div>${boxes} Ã— ${boxCost} = ${purchaseCost.toFixed(2)}</div>
        </div>
      </div>
      <div class="result-item">
        <strong>${feeTitle}ï¼š</strong>Â¥${fee.toFixed(2)}å…ƒ
        <div class="formula-hint">
          <div>è®¡ç®—ä¾æ®ï¼š</div>
          <div>å®é™…å‡ºè´§é‡ ${actualTon.toFixed(3)}å¨ Ã— ${feeRate}å…ƒ/å¨</div>
        </div>
      </div>
      <div class="result-item highlight">
        <strong>æ€»æˆæœ¬ï¼š</strong>Â¥${totalCost.toFixed(2)}å…ƒ
        <div class="formula-hint">
          <div>è®¡ç®—å…¬å¼ï¼š</div>
          <div>æ€»é‡‡è´­æˆæœ¬ + åŠ å·¥è´¹</div>
          <div>${totalPurchaseCost.toFixed(2)} + ${fee.toFixed(2)} = ${totalCost.toFixed(2)}</div>
        </div>
      </div>
      <div class="result-item highlight">
        <strong>é¢„ä¼°åˆ©æ¶¦ï¼š</strong>Â¥${profit}å…ƒ
        <div class="formula-hint">
          <div>è®¡ç®—å…¬å¼ï¼š</div>
          <div>é”€å”®æ€»é¢ - æ€»æˆæœ¬</div>
          <div>${sales.toFixed(2)} - ${totalCost.toFixed(2)} = ${profit}</div>
        </div>
      </div>
      <div class="result-item">
        <strong>é”€å”®åˆ©æ¶¦ç‡ï¼š</strong>${profitRatio}% 
        <span class="hint">(åˆ©æ¶¦/é”€å”®é¢)</span>
        <div class="formula-hint">
          <div>è®¡ç®—å…¬å¼ï¼š</div>
          <div>(åˆ©æ¶¦ Ã· é”€å”®é¢) Ã— 100%</div>
          <div>(${profit} Ã· ${sales.toFixed(2)}) Ã— 100% = ${profitRatio}%</div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ è®¾ç½®é¢æ¿ -->
    <div id="settings-panel" class="settings-panel hidden">
      <div class="settings-header">
        <h3>ç³»ç»Ÿè®¾ç½®</h3>
        <div class="settings-tabs">
          <button class="tab-btn active" onclick="switchSettingsTab('defaults')">é»˜è®¤å€¼è®¾ç½®</button>
          <button class="tab-btn" onclick="switchSettingsTab('display')">æ˜¾ç¤ºä¸å¤åˆ¶</button>
          <button class="tab-btn" onclick="switchSettingsTab('about')">å…³äº</button>
        </div>
      </div>

      <div id="defaults-settings" class="settings-section active">
        <h4>é»˜è®¤å€¼è®¾ç½®</h4>
        <!-- åŸºç¡€æ•°æ®é»˜è®¤å€¼ -->
        <div class="setting-group">
          <h5>åŸºç¡€æ•°æ®</h5>
        <div class="setting-item">
          <label>é‡‡è´­ç®±æ•°é»˜è®¤å€¼</label>
          <input type="number" id="default-boxes" step="1">
        </div>
        <div class="setting-item">
          <label>æ´—å§œæ¯ä»¶é‡é‡é»˜è®¤å€¼</label>
          <input type="number" id="default-clean-weight" step="0.01">
        </div>
        <div class="setting-item">
            <label>æ¯ç®±å‡€é‡</label>
            <div class="input-wrapper">
              <input type="number" id="default-net-weight" value="47.04" step="0.01" min="0">
              <span class="unit">æ–¤/ç®±</span>
        </div>
            <div class="detail-hint">é»˜è®¤47.04æ–¤/ç®±</div>
        </div>
        </div>
        
        <!-- ä»·æ ¼ç›¸å…³é»˜è®¤å€¼ -->
        <div class="setting-group">
          <h5>ä»·æ ¼è®¾ç½®</h5>
          <div class="setting-item">
            <label>é”€å”®å•ä»·é»˜è®¤å€¼</label>
            <input type="number" id="default-price" step="0.01">
          </div>
          <div class="setting-item">
            <label>åŸç®±å‡€é‡æˆæœ¬é»˜è®¤å€¼</label>
            <input type="number" id="default-box-cost" step="0.01">
          </div>
        </div>
        
        <!-- è´¹ç”¨ç›¸å…³é»˜è®¤å€¼ -->
        <div class="setting-group">
          <h5>è´¹ç”¨è®¾ç½®</h5>
        <div class="setting-item">
          <label>åŠ å·¥è´¹é»˜è®¤å€¼ï¼ˆå…ƒï¼‰</label>
          <input type="number" id="default-fee" step="0" value="0">
        </div>
        <div class="setting-item">
          <label>æ³¥å§œäººå·¥è´¹å•ä»·ï¼ˆå…ƒ/å¨ï¼‰</label>
          <input type="number" id="default-mud-labor-fee" step="1" value="100">
        </div>
        <div class="setting-item">
          <label>æ´—å§œåŠ å·¥è´¹å•ä»·ï¼ˆå…ƒ/å¨ï¼‰</label>
          <input type="number" id="default-clean-process-fee" step="1" value="500">
        </div>
        <div class="setting-item">
          <label>åŠ å·¥è´¹ä¿åº•é‡‘é¢</label>
          <input type="number" id="default-min-fee" value="0">
        </div>
        <div class="setting-item">
          <label>å…¶ä»–æ”¯å‡ºå æ¯”é»˜è®¤å€¼</label>
          <input type="number" id="default-expense-ratio" step="0.01">
        </div>
      </div>
      </div>

      <div id="display-settings" class="settings-section">
        <h4>æ˜¾ç¤ºä¸å¤åˆ¶è®¾ç½®</h4>
        <div class="setting-item">
          <label>åŸºç¡€ä¿¡æ¯</label>
          <div class="switch-options">
            <label class="switch-label">
              <input type="checkbox" id="display-formula">
              <span>æ˜¾ç¤ºè®¡ç®—å…¬å¼</span>
            </label>
            <label class="switch-label">
              <input type="checkbox" id="display-hint" checked>
              <span>æ˜¾ç¤ºæç¤ºä¿¡æ¯</span>
            </label>
            <label class="switch-label">
              <input type="checkbox" id="display-highlight" checked>
              <span>é«˜äº®é‡è¦ç»“æœ</span>
            </label>
            <label class="switch-label">
              <input type="checkbox" id="display-autoscroll" checked>
              <span>è‡ªåŠ¨æ»šåŠ¨åˆ°ç»“æœ</span>
            </label>
            <label class="switch-label">
              <input type="checkbox" id="copy-input-params" checked>
              <span>å¤åˆ¶è¾“å…¥å‚æ•°</span>
            </label>
          </div>
        </div>

        <div class="setting-item">
          <label>æ—¶é—´ä¸ç±»å‹</label>
          <div class="switch-options">
            <label class="switch-label">
              <span>æ—¶é—´æˆ³</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-timestamp" checked>
                  <label>æ˜¾ç¤º</label>
        </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-timestamp" checked>
                  <label>å¤åˆ¶</label>
      </div>
              </div>
            </label>
            <label class="switch-label">
              <span>è®¡ç®—ç±»å‹</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-type" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-type" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="setting-item">
          <label>æŸè€—åˆ†æç»“æœ</label>
          <div class="switch-options">
            <label class="switch-label">
              <span>å‡€é‡é‡‡è´­é‡</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-loss-net-purchase" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-loss-net-purchase" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
            <label class="switch-label">
              <span>æ¯›é‡é‡‡è´­é‡</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-loss-gross-purchase" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-loss-gross-purchase" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
            <label class="switch-label">
              <span>å®é™…å‡ºè´§é‡</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-loss-actual" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-loss-actual" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
            <label class="switch-label">
              <span>å‡€é‡æŸè€—æ¯”ä¾‹</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-loss-net-ratio" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-loss-net-ratio" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
            <label class="switch-label">
              <span>æ¯›é‡æŸè€—æ¯”ä¾‹</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-loss-gross-ratio" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-loss-gross-ratio" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="setting-item">
          <label>é”€å”®ç»“æœ</label>
          <div class="switch-options">
            <label class="switch-label">
              <span>é”€å”®æ€»é¢</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-sales-total" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-sales-total" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="setting-item">
          <label>åˆ©æ¶¦åˆ†æ</label>
          <div class="switch-options">
            <label class="switch-label">
              <span>é‡‡è´­æˆæœ¬</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-profit-cost" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-profit-cost" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
            <label class="switch-label">
              <span>åŠ å·¥è´¹ç”¨</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-profit-fee" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-profit-fee" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
            <label class="switch-label">
              <span>æ€»æˆæœ¬</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-profit-total" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-profit-total" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
            <label class="switch-label">
              <span>åˆ©æ¶¦</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-profit-result" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-profit-result" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
            <label class="switch-label">
              <span>é”€å”®åˆ©æ¶¦ç‡</span>
              <div class="switch-controls">
                <div class="control-group">
                  <input type="checkbox" id="display-profit-ratio" checked>
                  <label>æ˜¾ç¤º</label>
                </div>
                <div class="control-group">
                  <input type="checkbox" id="copy-profit-ratio" checked>
                  <label>å¤åˆ¶</label>
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- æ·»åŠ å¼€å‘è€…ä¿¡æ¯éƒ¨åˆ† -->
      <div id="about-settings" class="settings-section">
        <h4>å…³äº</h4>
        <div class="setting-item">
          <div class="about-info">
            <p><strong>ç”Ÿå§œç»è¥è®¡ç®—å™¨</strong></p>
            <p>ç‰ˆæœ¬: 3.0.2</p>
            <p>å¼€å‘è€…: ä½™æ’ä¼Ÿ</p>
            <p>è”ç³»æ–¹å¼: 121297290@qq.com</p>
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <button onclick="saveDefaults()">ä¿å­˜è®¾ç½®</button>
        <button onclick="resetDefaults()">æ¢å¤é»˜è®¤</button>
        <button onclick="window.location.href='history.html'" class="history-btn">
          <span class="btn-icon">ğŸ“œ</span>å†å²
        </button>
        <button onclick="toggleSettings()">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    // åœ¨è„šæœ¬å¼€å§‹å¤„æ·»åŠ ç«‹å³æ‰§è¡Œå‡½æ•°
    (function() {
      // å•ä½è½¬æ¢å¸¸é‡
      const JIN_TO_TON = 2000;
      
      // æ•°æ®å­˜å‚¨å¯¹è±¡
      let inputStates = {
        boxes: "",          // å‡ºè´§ç®±æ•°é»˜è®¤0
        "processed-boxes": "",  // å®é™…å‡ºè´§ä»¶æ•°é»˜è®¤0
        "clean-weight": "50",   // æ´—å§œé‡é‡é»˜è®¤50æ–¤
        price: "",
        fee: "",
        "box-cost": "155",
        "expense-ratio": "",
        "calculation-type": "loss",
        "sale-type": "mud",
        mudFeeManual: false,    // æ³¥å§œæ¨¡å¼æ‰‹åŠ¨è¾“å…¥æ ‡è®°
        cleanFeeManual: false,  // æ´—å§œæ¨¡å¼æ‰‹åŠ¨è¾“å…¥æ ‡è®°
        mudManualFee: null,     // æ³¥å§œæ¨¡å¼æ‰‹åŠ¨è¾“å…¥å€¼
        cleanManualFee: null,   // æ´—å§œæ¨¡å¼æ‰‹åŠ¨è¾“å…¥å€¼
        lastSaleType: 'mud'     // è®°å½•ä¸Šä¸€æ¬¡çš„é”€å”®ç±»å‹
      };

      // å…¨å±€çŠ¶æ€
      let isDetailMode = true;
      localStorage.setItem('detailMode', 'true');

      // ä¿®æ”¹ DEFAULT_SETTINGS å¯¹è±¡
      const DEFAULT_SETTINGS = {
        // åŸºç¡€æ•°æ®é»˜è®¤å€¼
        boxes: 0,
        cleanWeight: 50,
        netWeight: 47.04,
        
        // ä»·æ ¼ç›¸å…³é»˜è®¤å€¼
        price: 0,
        boxCost: 155,
        
        // è´¹ç”¨ç›¸å…³é»˜è®¤å€¼
        minFee: 0,
        mudLaborFee: 100,    // æ³¥å§œäººå·¥è´¹å•ä»·
        cleanProcessFee: 500, // æ´—å§œåŠ å·¥è´¹å•ä»·
        expenseRatio: 0,
        
        // æ˜¾ç¤ºé€‰é¡¹ä¿æŒä¸å˜
        displayOptions: {
          // ...
        },
        // å¤åˆ¶é€‰é¡¹ä¿æŒä¸å˜
        copyOptions: {
          // ...
        }
      };

      let currentSettings = {...DEFAULT_SETTINGS};

      // æ·»åŠ æ˜¾ç¤ºå’Œå¤åˆ¶è®¾ç½®çš„å…¨å±€å˜é‡
      let displaySettings = {};
      let copySettings = {};

      // å°†å‡½æ•°å®šä¹‰ä¸ºå…¨å±€
      window.toggleDetailMode = function() {
        isDetailMode = !isDetailMode;
        localStorage.setItem('detailMode', isDetailMode);
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œæ–‡å­—
        const btn = document.querySelector('.mode-btn');
        btn.classList.toggle('active');
        btn.innerHTML = isDetailMode ? 
          '<span class="btn-icon">ğŸ”</span>è¯¦ç»†' : 
          '<span class="btn-icon">ğŸ“±</span><span>ç®€æ´</span>';

        // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
        document.querySelectorAll('.formula-hint, .detail-hint, .explanation').forEach(el => {
          if (!el.classList.contains('mud-hint') && !el.classList.contains('clean-hint')) {
          el.style.display = isDetailMode ? 'block' : 'none';
          }
        });
        
        // å•ç‹¬å¤„ç†äººå·¥è´¹å’ŒåŠ å·¥è´¹è¯´æ˜çš„æ˜¾ç¤º
        const saleType = document.querySelector('input[name="sale-type"]:checked').value;
        const mudHint = document.querySelector('.mud-hint');
        const cleanHint = document.querySelector('.clean-hint');
        if (mudHint && cleanHint) {
          mudHint.style.display = isDetailMode && saleType === 'mud' ? 'block' : 'none';
          cleanHint.style.display = isDetailMode && saleType === 'clean' ? 'block' : 'none';
        }
        
        // å¼ºåˆ¶åˆ·æ–°è¯´æ˜å†…å®¹
        updateModeExplanation();
        updateSaleTypeExplanation();
        
        // å¦‚æœå·²æœ‰è®¡ç®—ç»“æœï¼Œé‡æ–°è®¡ç®—ä»¥æ›´æ–°æ˜¾ç¤º
        if(!document.getElementById('result-area').classList.contains('hidden')) {
          calculate();
        }
      };

      // åˆå§‹åŒ–é¡µé¢æ—¶æ¢å¤æ•°æ®
      function restoreInputValues() {
        Object.keys(inputStates).forEach(id => {
          const element = document.getElementById(id);
          if (element) element.value = inputStates[id];
        });
        document.getElementById('calculation-type').value = inputStates["calculation-type"];
        document.querySelector(`input[name="sale-type"][value="${inputStates["sale-type"]}"]`).checked = true;
      }

      // ä¿å­˜å½“å‰è¾“å…¥çŠ¶æ€
      function saveInputValues() {
        Object.keys(inputStates).forEach(id => {
          const element = document.getElementById(id);
          if (element) inputStates[id] = element.value;
        });
        inputStates["calculation-type"] = document.getElementById('calculation-type').value;
        inputStates["sale-type"] = document.querySelector('input[name="sale-type"]:checked').value;
        
        // å°†è¾“å…¥å€¼ä¿å­˜åˆ°localStorage
        localStorage.setItem('lastInputValues', JSON.stringify(inputStates));
      }

      // æ›´æ–°æ¨¡å¼è¯´æ˜
      function updateModeExplanation() {
        const calcType = document.getElementById('calculation-type').value;
        
        // éšè—æ‰€æœ‰è¯´æ˜
        document.querySelectorAll('#mode-explanation > div').forEach(el => {
          el.style.display = 'none';
        });
        
        // æ˜¾ç¤ºå½“å‰æ¨¡å¼è¯´æ˜ï¼ˆä»…åœ¨è¯¦ç»†æ¨¡å¼ï¼‰
        if(isDetailMode) {
          const currentDesc = document.getElementById(`${calcType}-desc`);
          if(currentDesc) currentDesc.style.display = 'block';
        }
      }

      // æ›´æ–°é”€å”®ç±»å‹è¯´æ˜
      function updateSaleTypeExplanation() {
        const saleType = document.querySelector('input[name="sale-type"]:checked').value;
        // å…ˆéšè—æ‰€æœ‰è¯´æ˜
        document.querySelectorAll('#sale-type-explanation > div').forEach(el => {
          el.style.display = 'none';
        });
        // æ˜¾ç¤ºå½“å‰ç±»å‹è¯´æ˜
        document.getElementById(`${saleType}-desc`).style.display = 'block';
      }

      // åŠ¨æ€æ˜¾ç¤ºæ§åˆ¶
      function updateUI() {
        const saleType = document.querySelector('input[name="sale-type"]:checked').value;
        const isClean = saleType === 'clean';
        const calcType = document.getElementById('calculation-type').value;

        // æ›´æ–°è´¹ç”¨è¾“å…¥æ¡†æ ‡ç­¾
        const feeLabel = document.querySelector('label[for="fee"]');
        if (feeLabel) {
          feeLabel.textContent = saleType === 'mud' ? 'äººå·¥è´¹ç”¨ï¼ˆå…ƒï¼‰' : 'åŠ å·¥è´¹ç”¨ï¼ˆå…ƒï¼‰';
        }

        // æ›´æ–°è¯´æ˜
        updateModeExplanation();
        updateSaleTypeExplanation();

        // æ›´æ–°é‡é‡è¾“å…¥å­—æ®µ
        const cleanWeightInput = document.getElementById('common-clean-weight');
        if (cleanWeightInput) {
          if (isClean) {
            cleanWeightInput.style.display = 'flex';
            cleanWeightInput.classList.remove('hidden');
          } else {
            cleanWeightInput.style.display = 'none';
            cleanWeightInput.classList.add('hidden');
          }
        }

        // æ§åˆ¶ä¸“å±è¾“å…¥åŒºåŸŸ
        document.querySelectorAll('[id$="-inputs"]').forEach(el => {
          el.classList.add('hidden');
        });

        // æ ¹æ®è®¡ç®—æ¨¡å¼æ˜¾ç¤ºç›¸åº”è¾“å…¥åŒºåŸŸ
        if (calcType === 'profit') {
          const salesInputs = document.getElementById('sales-inputs');
          const profitInputs = document.getElementById('profit-inputs');
          if (salesInputs) salesInputs.classList.remove('hidden');
          if (profitInputs) profitInputs.classList.remove('hidden');
        } else if (calcType === 'sales') {
          const salesInputs = document.getElementById('sales-inputs');
          if (salesInputs) salesInputs.classList.remove('hidden');
        }

        // æ›´æ–°åŠ å·¥è´¹è®¡ç®—ï¼ˆå¦‚æœåœ¨åˆ©æ¶¦æ ¸ç®—æ¨¡å¼ï¼‰
        if (calcType === 'profit' && !inputStates.isFeeManual) {
          updateProcessingFee();
        }

        // æ§åˆ¶è¯´æ˜æ˜¾ç¤º
        const explanations = document.querySelectorAll('.detail-hint, .formula-hint, .explanation');
        explanations.forEach(el => {
          if (el.classList.contains('mud-hint') || el.classList.contains('clean-hint')) {
            const saleType = document.querySelector('input[name="sale-type"]:checked').value;
            el.style.display = isDetailMode && 
              ((saleType === 'mud' && el.classList.contains('mud-hint')) || 
               (saleType === 'clean' && el.classList.contains('clean-hint'))) ? 'block' : 'none';
          } else {
            el.style.display = isDetailMode ? 'block' : 'none';
          }
        });

        // æ›´æ–°è´¹ç”¨è¯´æ˜æ˜¾ç¤º
        const mudHint = document.querySelector('.mud-hint');
        const cleanHint = document.querySelector('.clean-hint');
        if (mudHint && cleanHint) {
          mudHint.style.display = isDetailMode && saleType === 'mud' ? 'block' : 'none';
          cleanHint.style.display = isDetailMode && saleType === 'clean' ? 'block' : 'none';
        }
      }

      // è®¡ç®—æŸè€—åˆ†æ
      function calculateLoss() {
        // å…ˆè¿›è¡Œæ‰€æœ‰è®¡ç®—
        const boxes = parseFloat(inputStates.boxes);
        const cleanWeight = parseFloat(inputStates['clean-weight']);
        const processedBoxes = parseFloat(inputStates['processed-boxes']);
        
        // è·å–æ¯ç®±å‡€é‡è®¾ç½®
        const netWeightPerBox = currentSettings.netWeight || 47.04;
        
        // è®¡ç®—å‡€é‡é‡‡è´­é‡ï¼ˆå¨ï¼‰
        const netPurchaseTon = (boxes * netWeightPerBox) / 2000;
        
        // è®¡ç®—æ¯›é‡é‡‡è´­é‡ï¼ˆå¨ï¼‰
        const grossPurchaseTon = (boxes * 50) / 2000;
        
        // è®¡ç®—å®é™…å‡ºè´§é‡ï¼ˆå¨ï¼‰
        const actualTon = (processedBoxes * cleanWeight) / 2000;
        
        // è®¡ç®—å‡€é‡æŸè€—æ¯”ä¾‹
        const netLossRatio = ((netPurchaseTon - actualTon) / netPurchaseTon * 100).toFixed(2);
        
        // è®¡ç®—æ¯›é‡æŸè€—æ¯”ä¾‹
        const grossLossRatio = ((grossPurchaseTon - actualTon) / grossPurchaseTon * 100).toFixed(2);

        // ç„¶åæ ¹æ®æ˜¾ç¤ºè®¾ç½®ç”Ÿæˆ HTML
        return `
          <div class="result-section">
            <h4>æŸè€—åˆ†æç»“æœ</h4>
            ${document.getElementById('display-loss-net-purchase').checked ? `
            <div class="result-item">
              <strong>å‡€é‡é‡‡è´­é‡ï¼š</strong>${netPurchaseTon.toFixed(3)}å¨
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>é‡‡è´­ç®±æ•° Ã— ${netWeightPerBox}æ–¤/ç®± Ã· 2000æ–¤/å¨</div>
                <div>${boxes} Ã— ${netWeightPerBox} Ã· 2000 = ${netPurchaseTon.toFixed(3)}</div>
              </div>
            </div>` : ''}
            ${document.getElementById('display-loss-gross-purchase').checked ? `
            <div class="result-item">
              <strong>æ¯›é‡é‡‡è´­é‡ï¼š</strong>${grossPurchaseTon.toFixed(3)}å¨
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>å‡ºåº“ç®±æ•° Ã— 50æ–¤/ç®± Ã· 2000æ–¤/å¨</div>
                <div>${boxes} Ã— 50 Ã· 2000 = ${grossPurchaseTon.toFixed(3)}</div>
              </div>
            </div>` : ''}
            ${document.getElementById('display-loss-actual').checked ? `
            <div class="result-item">
              <strong>å®é™…å‡ºè´§é‡ï¼š</strong>${actualTon.toFixed(3)}å¨
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>å®é™…å‡ºè´§ä»¶æ•° Ã— ${cleanWeight}æ–¤/ä»¶ Ã· 2000æ–¤/å¨</div>
                <div>${processedBoxes} Ã— ${cleanWeight} Ã· 2000 = ${actualTon.toFixed(3)}</div>
              </div>
            </div>` : ''}
            ${document.getElementById('display-loss-net-ratio').checked ? `
            <div class="result-item highlight">
              <strong>å‡€é‡æŸè€—æ¯”ä¾‹ï¼š</strong>${netLossRatio}%
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>(å‡€é‡é‡‡è´­é‡ - å®é™…å‡ºè´§é‡) Ã· å‡€é‡é‡‡è´­é‡ Ã— 100%</div>
                <div>(${netPurchaseTon.toFixed(3)} - ${actualTon.toFixed(3)}) Ã· ${netPurchaseTon.toFixed(3)} Ã— 100% = ${netLossRatio}%</div>
              </div>
            </div>` : ''}
            ${document.getElementById('display-loss-gross-ratio').checked ? `
            <div class="result-item highlight">
              <strong>æ¯›é‡æŸè€—æ¯”ä¾‹ï¼š</strong>${grossLossRatio}%
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>(æ¯›é‡é‡‡è´­é‡ - å®é™…å‡ºè´§é‡) Ã· æ¯›é‡é‡‡è´­é‡ Ã— 100%</div>
                <div>(${grossPurchaseTon.toFixed(3)} - ${actualTon.toFixed(3)}) Ã· ${grossPurchaseTon.toFixed(3)} Ã— 100% = ${grossLossRatio}%</div>
              </div>
            </div>` : ''}
          </div>
        `;
      }

      // è®¡ç®—é”€å”®æ€»ä»·
      function calculateSales() {
        const processedBoxes = parseFloat(inputStates['processed-boxes']);
        const price = parseFloat(inputStates.price);
        const cleanWeight = parseFloat(inputStates['clean-weight']);
        const saleType = inputStates['sale-type'];
        
        // æ ¹æ®æ¨¡å¼é€‰æ‹©æ¯ä»¶é‡é‡
        const unitWeight = saleType === 'mud' ? 50 : cleanWeight; // æ³¥å§œå›ºå®š50æ–¤/ä»¶
        
        // è®¡ç®—é”€å”®æ€»é¢
        const salesTotal = processedBoxes * unitWeight * price; // ç›´æ¥è®¡ç®—æ€»é¢

        return `
          <div class="result-section">
            <h4>é”€å”®ç»“æœ</h4>
            ${document.getElementById('display-sales-total').checked ? `
            <div class="result-item highlight">
              <strong>é”€å”®æ€»é¢ï¼š</strong>${salesTotal.toFixed(2)}å…ƒ
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>é”€å”®ä»¶æ•° Ã— ${unitWeight}æ–¤/ä»¶ Ã— ${price}å…ƒ/æ–¤</div>
                <div>${processedBoxes} Ã— ${unitWeight} Ã— ${price} = ${salesTotal.toFixed(2)}</div>
              </div>
            </div>` : ''}
          </div>
        `;
      }

      // è®¡ç®—åˆ©æ¶¦æ ¸ç®—
      function calculateProfit() {
        // è®¡ç®—actualTon
        const saleType = document.querySelector('input[name="sale-type"]:checked').value;
        const isMud = saleType === 'mud';
        const unitWeight = isMud ? 50 : parseFloat(inputStates["clean-weight"]) || 0;
        const processedBoxes = parseFloat(inputStates["processed-boxes"]) || 0;
        const actualTon = (processedBoxes * unitWeight) / 2000;

        // è®¡ç®—é”€å”®æ€»é¢
        const price = parseFloat(inputStates.price);
        const sales = (unitWeight * processedBoxes * price);

        // è®¡ç®—é‡‡è´­æˆæœ¬
        const boxCost = parseFloat(inputStates["box-cost"]);
        const boxes = parseFloat(inputStates.boxes);
        const purchaseCost = boxCost * boxes;

        const fee = parseFloat(inputStates.fee);
        
        // è®¡ç®—æ€»æˆæœ¬ (é‡‡è´­æˆæœ¬ + åŠ å·¥è´¹)
        const totalCost = purchaseCost + fee;
        
        // è®¡ç®—åˆ©æ¶¦
        const profit = (sales - totalCost).toFixed(2);
        
        // è®¡ç®—åˆ©æ¶¦ç‡
        const profitRatio = (profit / sales * 100).toFixed(2);

        // æ ¹æ®æ¨¡å¼é€‰æ‹©è´¹ç”¨åç§°å’Œè´¹ç‡
        const feeTitle = isMud ? 'äººå·¥è´¹ç”¨' : 'åŠ å·¥è´¹ç”¨';
        const feeRate = isMud ? currentSettings.mudLaborFee : currentSettings.cleanProcessFee;

        return `
          <div class="result-section">
            <h4>åˆ©æ¶¦åˆ†æ</h4>
            ${document.getElementById('display-profit-cost').checked ? `
            <div class="result-item">
              <strong>é‡‡è´­æˆæœ¬ï¼š</strong>Â¥${purchaseCost.toFixed(2)}å…ƒ
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>å‡ºåº“ç®±æ•° Ã— æ¯ç®±é‡‡è´­ä»·æ ¼</div>
                <div>${boxes} Ã— ${boxCost} = ${purchaseCost.toFixed(2)}</div>
              </div>
            </div>` : ''}
            <div class="result-item">
              <strong>${feeTitle}ï¼š</strong>Â¥${fee.toFixed(2)}å…ƒ
              <div class="formula-hint">
                <div>è®¡ç®—ä¾æ®ï¼š</div>
                <div>å®é™…å‡ºè´§é‡ ${actualTon.toFixed(3)}å¨ Ã— ${feeRate}å…ƒ/å¨</div>
              </div>
            </div>
            <div class="result-item highlight">
              <strong>æ€»æˆæœ¬ï¼š</strong>Â¥${totalCost.toFixed(2)}å…ƒ
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>é‡‡è´­æˆæœ¬ + åŠ å·¥è´¹</div>
                <div>${purchaseCost.toFixed(2)} + ${fee.toFixed(2)} = ${totalCost.toFixed(2)}</div>
              </div>
            </div>
            <div class="result-item highlight">
              <strong>é¢„ä¼°åˆ©æ¶¦ï¼š</strong>Â¥${profit}å…ƒ
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>é”€å”®æ€»é¢ - æ€»æˆæœ¬</div>
                <div>${sales.toFixed(2)} - ${totalCost.toFixed(2)} = ${profit}</div>
              </div>
            </div>
            <div class="result-item">
              <strong>é”€å”®åˆ©æ¶¦ç‡ï¼š</strong>${profitRatio}% 
              <span class="hint">(åˆ©æ¶¦/é”€å”®é¢)</span>
              <div class="formula-hint">
                <div>è®¡ç®—å…¬å¼ï¼š</div>
                <div>(åˆ©æ¶¦ Ã· é”€å”®é¢) Ã— 100%</div>
                <div>(${profit} Ã· ${sales.toFixed(2)}) Ã— 100% = ${profitRatio}%</div>
              </div>
            </div>
          </div>
        `;
      }

      // ä¿®æ”¹åŠ å·¥è´¹è®¡ç®—é€»è¾‘
      function updateProcessingFee() {
        const saleType = document.querySelector('input[name="sale-type"]:checked').value;
        // å¦‚æœå½“å‰æ¨¡å¼å·²ç»æ‰‹åŠ¨è¾“å…¥è¿‡ï¼Œåˆ™ä¸è‡ªåŠ¨è®¡ç®—
        if ((saleType === 'mud' && inputStates.mudFeeManual) || 
            (saleType === 'clean' && inputStates.cleanFeeManual)) {
          return;
        }
        
        const processedBoxes = parseFloat(inputStates['processed-boxes']) || 0;
        const cleanWeight = parseFloat(inputStates['clean-weight']) || 0;
        const isMud = saleType === 'mud';
        
        // æ ¹æ®æ¨¡å¼é€‰æ‹©æ¯ä»¶é‡é‡å’Œè´¹ç‡
        const unitWeight = isMud ? 50 : cleanWeight;
        const feeRate = isMud ? currentSettings.mudLaborFee : currentSettings.cleanProcessFee;
        
        // è®¡ç®—å®é™…å‡ºè´§é‡ï¼ˆå¨ï¼‰
          const actualTon = (processedBoxes * unitWeight) / 2000;
        
        // è®¡ç®—è´¹ç”¨ï¼ˆä¸ä½äºä¿åº•é‡‘é¢ï¼‰
        const calculatedFee = Math.max(actualTon * feeRate, currentSettings.minFee);
        
        // æ›´æ–°è´¹ç”¨è¾“å…¥æ¡†
        document.getElementById('fee').value = calculatedFee.toFixed(2);
        inputStates.fee = calculatedFee.toFixed(2);
      }

      // æ ¸å¿ƒè®¡ç®—å‡½æ•°
      function calculate() {
        // æ£€æŸ¥æ˜¯å¦æ˜¯ä»å†å²è®°å½•è·³è½¬æ¥çš„
        const isPendingCalculation = localStorage.getItem('pendingCalculation');
        
        saveInputValues();
        const calcType = inputStates["calculation-type"];
        let resultHTML = '';

        // ä¿ç•™ç»“æœåŒºåŸŸæ§åˆ¶é€»è¾‘
        document.querySelectorAll('.results').forEach(el => {
          el.classList.add('hidden');
        });
        
        // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºå¯¹åº”ç»“æœ
        switch(calcType) {
          case 'loss':
            resultHTML = `
              <div class="result-section">
                ${calculateLoss()}
              </div>
            `;
            break;
          case 'sales':
            resultHTML = `
              <div class="result-section">
                ${calculateLoss()}
              </div>
              <div class="result-section">
                ${calculateSales()}
              </div>
            `;
            break;
          case 'profit':
            resultHTML = `
              <div class="result-section">
                ${calculateLoss()}
              </div>
              <div class="result-section">
                ${calculateSales()}
              </div>
              <div class="result-section">
                ${calculateProfit()}
              </div>
            `;
            break;
        }

        // æ˜¾ç¤ºç»“æœ
        document.getElementById('result-content').innerHTML = resultHTML;
        document.getElementById('result-area').classList.remove('hidden');

        // æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®
        document.getElementById('copy-btn').style.display = 'block';
        document.getElementById('calculate-btn').style.width = 'calc(100% - 130px)';

        // åº”ç”¨æ˜¾ç¤ºè®¾ç½®
        const resultItems = document.querySelectorAll('.result-item');
        resultItems.forEach(item => {
          const titleEl = item.querySelector('strong');
          if (!titleEl) return;
          
          const title = titleEl.textContent;
          
          // é»˜è®¤æ˜¾ç¤º
          item.style.display = 'block';
          
          // æ£€æŸ¥å„é¡¹æ˜¾ç¤ºè®¾ç½®
          if (title.includes('é‡‡è´­é‡') && !document.getElementById('display-loss-net-purchase').checked && !document.getElementById('display-loss-gross-purchase').checked ||
              title.includes('å®é™…å‡ºè´§é‡') && !document.getElementById('display-loss-actual').checked ||
              title.includes('æŸè€—æ¯”ä¾‹') && !document.getElementById('display-loss-net-ratio').checked && !document.getElementById('display-loss-gross-ratio').checked ||
              title.includes('é”€å”®æ€»é¢') && !document.getElementById('display-sales-total').checked ||
              title.includes('é‡‡è´­æˆæœ¬') && !document.getElementById('display-profit-cost').checked ||
              title.includes('åŠ å·¥è´¹ç”¨') && !document.getElementById('display-profit-fee').checked ||
              title.includes('æ€»æˆæœ¬') && !document.getElementById('display-profit-total').checked ||
              title.includes('é¢„ä¼°åˆ©æ¶¦') && !document.getElementById('display-profit-result').checked ||
              title.includes('åˆ©æ¶¦ç‡') && !document.getElementById('display-profit-ratio').checked) {
            item.style.display = 'none';
          }
        });

        // æ ¹æ®è¯¦ç»†æ¨¡å¼çŠ¶æ€æ§åˆ¶å…¬å¼æ˜¾ç¤º
        document.querySelectorAll('.formula-hint, .detail-hint, .explanation').forEach(el => {
          if (el.classList.contains('mud-hint') || el.classList.contains('clean-hint')) {
            const saleType = document.querySelector('input[name="sale-type"]:checked').value;
            el.style.display = isDetailMode && 
              ((saleType === 'mud' && el.classList.contains('mud-hint')) || 
               (saleType === 'clean' && el.classList.contains('clean-hint'))) ? 'block' : 'none';
          } else {
            el.style.display = isDetailMode ? 'block' : 'none';
          }
        });

        // åº”ç”¨æ˜¾ç¤ºé€‰é¡¹
        if (!currentSettings.displayOptions.showHint) {
          document.querySelectorAll('.hint').forEach(el => el.style.display = 'none');
        }
        
        if (!currentSettings.displayOptions.highlightImportant) {
          document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
        }
        
        // è‡ªåŠ¨æ»šåŠ¨
        if (currentSettings.displayOptions.autoScroll) {
        document.getElementById('result-area').scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
        }

        // æ ¹æ®æ˜¾ç¤ºé€‰é¡¹æ§åˆ¶ç»“æœæ˜¾ç¤º
        window.updateResultVisibility();

        // å¦‚æœæ˜¯ä»å†å²è®°å½•è·³è½¬æ¥çš„ï¼Œæ¸…é™¤æ ‡è®°
        if (isPendingCalculation) {
          localStorage.removeItem('pendingCalculation');
        }
      }

      // äº‹ä»¶ç›‘å¬
      document.getElementById('calculation-type').addEventListener('change', function() {
        saveInputValues();
        updateUI();
        restoreInputValues();
        inputStates.isFeeManual = false; // åˆ‡æ¢æ¨¡å¼æ—¶é‡ç½®
      });

      document.querySelectorAll('input[name="sale-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const newSaleType = this.value;
          const feeInput = document.getElementById('fee');
          
          // æ ¹æ®æ–°æ¨¡å¼çš„çŠ¶æ€å†³å®šæ˜¯å¦ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥å€¼
          if (newSaleType === 'mud' && inputStates.mudFeeManual) {
            feeInput.value = inputStates.mudManualFee;
            inputStates.fee = inputStates.mudManualFee;
          } else if (newSaleType === 'clean' && inputStates.cleanFeeManual) {
            feeInput.value = inputStates.cleanManualFee;
            inputStates.fee = inputStates.cleanManualFee;
            } else {
            // å¦‚æœè¯¥æ¨¡å¼æ²¡æœ‰æ‰‹åŠ¨è¾“å…¥è¿‡ï¼Œåˆ™è‡ªåŠ¨è®¡ç®—
            updateProcessingFee();
            }
          
          inputStates.lastSaleType = newSaleType;
          saveInputValues();
          updateUI();
          restoreInputValues();
        });
      });

      // ç¡®ä¿äº‹ä»¶ç›‘å¬æ­£ç¡®åˆå§‹åŒ–
      function initEventListeners() {
        // å®æ—¶è®¡ç®—åŠ å·¥è´¹ç”¨
        document.getElementById('processed-boxes').addEventListener('input', updateProcessingFee);
        document.getElementById('clean-weight').addEventListener('input', updateProcessingFee);
        document.querySelectorAll('input[name="sale-type"]').forEach(radio => {
          radio.addEventListener('change', updateProcessingFee);
        });

        // æ–°å¢æ‰‹åŠ¨ä¿®æ”¹ç›‘å¬
        document.getElementById('fee').addEventListener('input', function() {
          const saleType = document.querySelector('input[name="sale-type"]:checked').value;
          // æ ¹æ®å½“å‰æ¨¡å¼è®¾ç½®å¯¹åº”çš„æ‰‹åŠ¨æ ‡è®°
          if (saleType === 'mud') {
            inputStates.mudFeeManual = true;
            inputStates.mudManualFee = this.value;
          } else {
            inputStates.cleanFeeManual = true;
            inputStates.cleanManualFee = this.value;
          }
          saveInputValues();
        });

        // æ·»åŠ æ‰€æœ‰è¾“å…¥é¡¹çš„ç›‘å¬ï¼Œç¡®ä¿æ•°æ®å®æ—¶ä¿å­˜
        const inputElements = [
          'boxes', 
          'processed-boxes', 
          'clean-weight', 
          'price', 
          'fee', 
          'box-cost', 
          'expense-ratio'
        ];
        
        inputElements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener('input', saveInputValues);
          }
        });
        
        // ç›‘å¬è®¡ç®—ç±»å‹å˜åŒ–
        document.getElementById('calculation-type').addEventListener('change', saveInputValues);

        // ä¿®æ”¹é”€å”®ç±»å‹åˆ‡æ¢çš„ç›‘å¬
        document.querySelectorAll('input[name="sale-type"]').forEach(radio => {
          radio.addEventListener('change', function() {
            const newSaleType = this.value;
            const feeInput = document.getElementById('fee');
            
            // æ ¹æ®æ–°æ¨¡å¼çš„çŠ¶æ€å†³å®šæ˜¯å¦ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥å€¼
            if (newSaleType === 'mud' && inputStates.mudFeeManual) {
              feeInput.value = inputStates.mudManualFee;
              inputStates.fee = inputStates.mudManualFee;
            } else if (newSaleType === 'clean' && inputStates.cleanFeeManual) {
              feeInput.value = inputStates.cleanManualFee;
              inputStates.fee = inputStates.cleanManualFee;
            } else {
              // å¦‚æœè¯¥æ¨¡å¼æ²¡æœ‰æ‰‹åŠ¨è¾“å…¥è¿‡ï¼Œåˆ™è‡ªåŠ¨è®¡ç®—
              updateProcessingFee();
            }
            
            inputStates.lastSaleType = newSaleType;
            saveInputValues();
            updateUI();
            restoreInputValues();
          });
        });
      }

      // åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­æ·»åŠ æ£€æŸ¥å¾…è®¡ç®—å‚æ•°çš„é€»è¾‘
      function init() {
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ‰€æœ‰è®¾ç½®
        const savedSettings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        currentSettings = { ...DEFAULT_SETTINGS, ...savedSettings };
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¸Šæ¬¡ç”¨æˆ·è¾“å…¥å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
        const lastInputValues = localStorage.getItem('lastInputValues');
        if (lastInputValues) {
          const savedInputs = JSON.parse(lastInputValues);
          Object.keys(savedInputs).forEach(key => {
            inputStates[key] = savedInputs[key];
          });
        }
        
        // åº”ç”¨ä¿å­˜çš„è®¾ç½®åˆ°è¾“å…¥æ¡†
        restoreInputValues(); // ä½¿ç”¨inputStatesä¸­çš„å€¼å¡«å……è¡¨å•
        
        // æ›´æ–°åŠ å·¥è´¹ç›¸å…³è®¾ç½®
        window.MIN_FEE = currentSettings.minFee;
        document.querySelectorAll('#current-fee-rate').forEach(el => {
          el.textContent = currentSettings.processingFee;
        });
        
        // é»˜è®¤ä¸ºè¯¦ç»†æ¨¡å¼
        const savedDetailMode = localStorage.getItem('detailMode');
        if (savedDetailMode === null) {
          // åªæœ‰é¦–æ¬¡åŠ è½½æ—¶è®¾ç½®ä¸ºè¯¦ç»†æ¨¡å¼
          isDetailMode = true;
          localStorage.setItem('detailMode', 'true');
          // æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œæ–‡å­—
          const btn = document.querySelector('.mode-btn');
          btn.classList.add('active');
          btn.innerHTML = '<span class="btn-icon">ğŸ“‹</span><span>è¯¦ç»†</span>';
        } else {
          // ä½¿ç”¨ä¿å­˜çš„æ¨¡å¼
          isDetailMode = savedDetailMode === 'true';
          // æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œæ–‡å­—
          const btn = document.querySelector('.mode-btn');
          if (isDetailMode) {
            btn.classList.add('active');
            btn.innerHTML = '<span class="btn-icon">ğŸ“‹</span><span>è¯¦ç»†</span>';
          } else {
            btn.classList.remove('active');
            btn.innerHTML = '<span class="btn-icon">ğŸ“±</span><span>ç®€æ´</span>';
          }
        }

        // æ ¹æ®å½“å‰æ¨¡å¼æ§åˆ¶è¯´æ˜æ˜¾ç¤º
        document.querySelectorAll('.formula-hint, .detail-hint, .explanation').forEach(el => {
          if (el.classList.contains('mud-hint') || el.classList.contains('clean-hint')) {
            const saleType = document.querySelector('input[name="sale-type"]:checked').value;
            el.style.display = isDetailMode && 
              ((saleType === 'mud' && el.classList.contains('mud-hint')) || 
               (saleType === 'clean' && el.classList.contains('clean-hint'))) ? 'block' : 'none';
          } else {
            el.style.display = isDetailMode ? 'block' : 'none';
          }
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        initEventListeners();
        
        // æ›´æ–°UI
        updateUI();
        
        // åŠ è½½ä¿å­˜çš„æ˜¾ç¤ºå’Œå¤åˆ¶è®¾ç½®
        loadCurrentSettings();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å¾…è®¡ç®—çš„å‚æ•°
        const pendingCalc = localStorage.getItem('pendingCalculation');
        if (pendingCalc) {
          try {
            const { type, values } = JSON.parse(pendingCalc);
            
            // è®¾ç½®è®¡ç®—ç±»å‹
            document.getElementById('calculation-type').value = type;
            
            // è®¾ç½®é”€å”®ç±»å‹
            const saleTypeRadio = document.querySelector(`input[name="sale-type"][value="${values['sale-type']}"]`);
            if (saleTypeRadio) saleTypeRadio.checked = true;
            
            // å¡«å……æ‰€æœ‰è¾“å…¥å€¼
            Object.keys(values).forEach(key => {
              const input = document.getElementById(key);
              if (input) input.value = values[key];
            });
            
            // æ¸…é™¤å¾…è®¡ç®—å‚æ•°
            localStorage.removeItem('pendingCalculation');
            
            // æ›´æ–°UIå¹¶æ‰§è¡Œè®¡ç®—
            saveInputValues();
            updateUI();
            calculate();
          } catch (e) {
            console.error('Error applying pending calculation:', e);
            localStorage.removeItem('pendingCalculation');
          }
        }
      }

      // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.onload = function() {
        init();
        
        // é¦–æ¬¡åŠ è½½ä¸è‡ªåŠ¨è®¡ç®—
        document.getElementById('result-area').classList.add('hidden');
        document.getElementById('copy-btn').style.display = 'none';
        document.getElementById('calculate-btn').style.width = '100%';
        
        // æ¸…é™¤é¦–æ¬¡è®¡ç®—æ ‡è®°
        delete window.hasCalculated;
      }

      // æ­£ç¡®æš´éœ²calculateå‡½æ•°
      window.calculate = calculate;

      // å°†å‡½æ•°å®šä¹‰ä¸ºå…¨å±€å‡½æ•°
      window.toggleSettings = function() {
        const panel = document.getElementById('settings-panel');
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden')) {
          loadCurrentSettings();
          // è‡ªåŠ¨æ»šåŠ¨åˆ°è®°å¿†åŠŸèƒ½åŒºåŸŸ
          setTimeout(() => {
            const memorySection = document.getElementById('memory-settings');
            if (memorySection) {
              memorySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              memorySection.style.animation = 'highlight 1.5s ease-out';
            }
          }, 300);
          // é»˜è®¤æ˜¾ç¤ºåŸºç¡€è®¾ç½®æ ‡ç­¾
          switchSettingsTab('defaults');
        }
      }

      // ä¿®æ”¹ loadCurrentSettings å‡½æ•°ï¼Œç¡®ä¿æ­£ç¡®åŠ è½½æ˜¾ç¤ºè®¾ç½®
      window.loadCurrentSettings = function() {
        // ä»æœ¬åœ°å­˜å‚¨è·å–æ‰€æœ‰è®¾ç½®
        const savedSettings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        displaySettings = JSON.parse(localStorage.getItem('displaySettings') || '{}');
        copySettings = JSON.parse(localStorage.getItem('copySettings') || '{}');
        
        currentSettings = { ...DEFAULT_SETTINGS, ...savedSettings };
        
        // åŠ è½½æ‰€æœ‰é»˜è®¤å€¼åˆ°è®¾ç½®é¢æ¿
        document.getElementById('default-boxes').value = currentSettings.boxes;
        document.getElementById('default-clean-weight').value = currentSettings.cleanWeight;
        document.getElementById('default-net-weight').value = currentSettings.netWeight;
        document.getElementById('default-price').value = currentSettings.price;
        document.getElementById('default-box-cost').value = currentSettings.boxCost;
        document.getElementById('default-fee').value = currentSettings.fee;
        document.getElementById('default-mud-labor-fee').value = currentSettings.mudLaborFee;
        document.getElementById('default-clean-process-fee').value = currentSettings.cleanProcessFee;
        document.getElementById('default-min-fee').value = currentSettings.minFee;
        document.getElementById('default-expense-ratio').value = currentSettings.expenseRatio;
        
        // è®¾ç½®æ˜¾ç¤ºé€‰é¡¹çš„å¤é€‰æ¡†çŠ¶æ€
        const displayDefaults = {
          'display-loss-net-purchase': true,
          'display-loss-gross-purchase': true,
          'display-loss-actual': true,
          'display-loss-net-ratio': true,
          'display-loss-gross-ratio': true,
          'display-sales-amount': true,
          'display-sales-total': true,
          'display-profit-cost': true,
          'display-profit-fee': true,
          'display-profit-total': true,
          'display-profit-result': true,
          'display-profit-ratio': true,
          'display-formula': false,
          'display-hint': true,
          'display-highlight': true,
          'display-autoscroll': true
        };

        // åˆå¹¶é»˜è®¤å€¼å’Œä¿å­˜çš„è®¾ç½®
        Object.keys(displayDefaults).forEach(id => {
          const checkbox = document.getElementById(id);
          if (checkbox) {
            checkbox.checked = displaySettings[id] !== undefined ? displaySettings[id] : displayDefaults[id];
          }
        });

        // è®¾ç½®å¤åˆ¶é€‰é¡¹çš„å¤é€‰æ¡†çŠ¶æ€
        const copyDefaults = {
          'copy-timestamp': true,
          'copy-type': true,
          'copy-input-params': true,
          'copy-loss-net-purchase': true,
          'copy-loss-gross-purchase': true,
          'copy-loss-actual': true,
          'copy-loss-net-ratio': true,
          'copy-loss-gross-ratio': true,
          'copy-sales-amount': true,
          'copy-sales-total': true,
          'copy-profit-cost': true,
          'copy-profit-fee': true,
          'copy-profit-total': true,
          'copy-profit-result': true,
          'copy-profit-ratio': true
        };

        // åˆå¹¶é»˜è®¤å€¼å’Œä¿å­˜çš„è®¾ç½®
        Object.keys(copyDefaults).forEach(id => {
          const checkbox = document.getElementById(id);
          if (checkbox) {
            checkbox.checked = copySettings[id] !== undefined ? copySettings[id] : copyDefaults[id];
          }
        });

        // æ›´æ–°è´¹ç‡æ˜¾ç¤º
        document.getElementById('current-mud-fee-rate').textContent = currentSettings.mudLaborFee;
        document.getElementById('current-clean-fee-rate').textContent = currentSettings.cleanProcessFee;
      }

      // åœ¨ IIFE ä¸­ä¿®æ”¹ resetDefaults å‡½æ•°å®šä¹‰
      window.resetDefaults = function() {
        localStorage.removeItem('userSettings');
        localStorage.removeItem('displaySettings');
        localStorage.removeItem('copySettings');
        localStorage.removeItem('lastInputValues'); // æ¸…é™¤ä¿å­˜çš„è¾“å…¥å€¼
        currentSettings = {...DEFAULT_SETTINGS};
        displaySettings = {};
        copySettings = {};
        // é‡ç½®è¾“å…¥çŠ¶æ€
        inputStates = {
          "boxes": '',
          "processed-boxes": '',
          "clean-weight": '50',
          "price": '',
          "fee": '0',
          "box-cost": '155',
          "mudFeeManual": false,
          "cleanFeeManual": false,
          "calculation-type": 'profit',
          "sale-type": 'mud'
        };
        applySettings();
        loadCurrentSettings();
        toggleSettings();
      }

      function applySettings() {
        document.getElementById('boxes').value = currentSettings.boxes;
        document.getElementById('clean-weight').value = currentSettings.cleanWeight;
        document.getElementById('price').value = currentSettings.price;
        document.getElementById('box-cost').value = currentSettings.boxCost;
        document.getElementById('fee').value = currentSettings.fee || 0;
        
        // æ›´æ–°åŠ å·¥è´¹è®¡ç®—é€»è¾‘
        window.MIN_FEE = currentSettings.minFee;
        
        saveInputValues();
        updateUI();
        calculate();
        
        // æ›´æ–°åŠ å·¥è´¹è¯´æ˜
        document.querySelectorAll('#current-fee-rate').forEach(el => {
          el.textContent = currentSettings.processingFee || 110;
        });
      }

      // å°† switchSettingsTab å‡½æ•°å®šä¹‰ä¸ºå…¨å±€å‡½æ•°
      window.switchSettingsTab = function(tabName) {
        // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`.tab-btn[onclick*="${tabName}"]`).classList.add('active');
        
        // æ›´æ–°è®¾ç½®åŒºåŸŸæ˜¾ç¤º
        document.querySelectorAll('.settings-section').forEach(section => {
          section.classList.remove('active');
        });
        document.getElementById(`${tabName}-settings`).classList.add('active');
      }

      // å°† saveDefaults å‡½æ•°å®šä¹‰ä¸ºå…¨å±€å‡½æ•°
      window.saveDefaults = function() {
        // ä¿å­˜æ‰€æœ‰é»˜è®¤å€¼
        currentSettings.boxes = Number(document.getElementById('default-boxes').value);
        currentSettings.cleanWeight = Number(document.getElementById('default-clean-weight').value);
        currentSettings.netWeight = Number(document.getElementById('default-net-weight').value);
        currentSettings.price = Number(document.getElementById('default-price').value);
        currentSettings.boxCost = Number(document.getElementById('default-box-cost').value);
        currentSettings.fee = Number(document.getElementById('default-fee').value);
        currentSettings.mudLaborFee = Number(document.getElementById('default-mud-labor-fee').value);
        currentSettings.cleanProcessFee = Number(document.getElementById('default-clean-process-fee').value);
        currentSettings.minFee = Number(document.getElementById('default-min-fee').value);
        currentSettings.expenseRatio = Number(document.getElementById('default-expense-ratio').value);

        // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è·å–å¤é€‰æ¡†çŠ¶æ€
        function getCheckboxState(id, defaultValue = true) {
          const checkbox = document.getElementById(id);
          return checkbox ? checkbox.checked : defaultValue;
        }

        // ä¿å­˜æ˜¾ç¤ºè®¾ç½®
        displaySettings = {
          'display-loss-net-purchase': getCheckboxState('display-loss-net-purchase'),
          'display-loss-gross-purchase': getCheckboxState('display-loss-gross-purchase'),
          'display-loss-actual': getCheckboxState('display-loss-actual'),
          'display-loss-net-ratio': getCheckboxState('display-loss-net-ratio'),
          'display-loss-gross-ratio': getCheckboxState('display-loss-gross-ratio'),
          'display-sales-amount': getCheckboxState('display-sales-amount'),
          'display-sales-total': getCheckboxState('display-sales-total'),
          'display-profit-cost': getCheckboxState('display-profit-cost'),
          'display-profit-fee': getCheckboxState('display-profit-fee'),
          'display-profit-total': getCheckboxState('display-profit-total'),
          'display-profit-result': getCheckboxState('display-profit-result'),
          'display-profit-ratio': getCheckboxState('display-profit-ratio'),
          'display-formula': getCheckboxState('display-formula', false),
          'display-hint': getCheckboxState('display-hint'),
          'display-highlight': getCheckboxState('display-highlight'),
          'display-autoscroll': getCheckboxState('display-autoscroll')
        };

        // ä¿å­˜å¤åˆ¶è®¾ç½®
        copySettings = {
          'copy-timestamp': getCheckboxState('copy-timestamp'),
          'copy-type': getCheckboxState('copy-type'),
          'copy-input-params': getCheckboxState('copy-input-params'),
          'copy-loss-net-purchase': getCheckboxState('copy-loss-net-purchase'),
          'copy-loss-gross-purchase': getCheckboxState('copy-loss-gross-purchase'),
          'copy-loss-actual': getCheckboxState('copy-loss-actual'),
          'copy-loss-net-ratio': getCheckboxState('copy-loss-net-ratio'),
          'copy-loss-gross-ratio': getCheckboxState('copy-loss-gross-ratio'),
          'copy-sales-amount': getCheckboxState('copy-sales-amount'),
          'copy-sales-total': getCheckboxState('copy-sales-total'),
          'copy-profit-cost': getCheckboxState('copy-profit-cost'),
          'copy-profit-fee': getCheckboxState('copy-profit-fee'),
          'copy-profit-total': getCheckboxState('copy-profit-total'),
          'copy-profit-result': getCheckboxState('copy-profit-result'),
          'copy-profit-ratio': getCheckboxState('copy-profit-ratio')
        };

        // ä¿å­˜æ‰€æœ‰è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('userSettings', JSON.stringify(currentSettings));
        localStorage.setItem('displaySettings', JSON.stringify(displaySettings));
        localStorage.setItem('copySettings', JSON.stringify(copySettings));

        applySettings();
        toggleSettings();
      }

      // è®°å¿†åŠŸèƒ½è®¾ç½®åŒºå—
document.getElementById('settings-panel').innerHTML += `
<div class="settings-section" id="memory-settings" style="border: 2px solid #ff9900; border-radius: 8px; padding: 15px; margin: 20px 0;">
  <h3 style="color: #ff9900; margin-bottom: 12px;">ğŸ§  è®°å¿†åŠŸèƒ½è®¾ç½®</h3>
  <div class="setting-item">
    <label class="switch">
      <input type="checkbox" id="enable-memory" checked>
      <span class="slider"></span>
      <span class="label-text">è‡ªåŠ¨è®°å¿†è¾“å…¥å‚æ•°</span>
    </label>
  </div>
  <div class="setting-item">
    <label class="switch">
      <input type="checkbox" id="auto-scroll-memory">
      <span class="slider"></span>
      <span class="label-text">æ‰“å¼€è®¾ç½®æ—¶è‡ªåŠ¨å®šä½</span>
    </label>
  </div>
</div>`;

// åœ¨ IIFE ä¸­æ·»åŠ  updateResultVisibility å‡½æ•°å®šä¹‰
      // æ ¹æ®æ˜¾ç¤ºé€‰é¡¹æ§åˆ¶ç»“æœæ˜¾ç¤º
      window.updateResultVisibility = function() {
        const resultSections = document.querySelectorAll('.result-section');
        
        // æŸè€—åˆ†æéƒ¨åˆ†
        const lossSection = resultSections[0];
        if (lossSection) {
          const lossItems = lossSection.querySelectorAll('.result-item');
          lossItems.forEach(item => {
            const text = item.querySelector('strong').textContent;
            item.style.display = 'block';
            if (text.includes('å‡€é‡é‡‡è´­é‡') && !document.getElementById('display-loss-net-purchase').checked) {
              item.style.display = 'none';
            }
            if (text.includes('æ¯›é‡é‡‡è´­é‡') && !document.getElementById('display-loss-gross-purchase').checked) {
              item.style.display = 'none';
            }
            if (text.includes('å®é™…å‡ºè´§é‡') && !document.getElementById('display-loss-actual').checked) {
              item.style.display = 'none';
            }
            if (text.includes('å‡€é‡æŸè€—æ¯”ä¾‹') && !document.getElementById('display-loss-net-ratio').checked) {
              item.style.display = 'none';
            }
            if (text.includes('æ¯›é‡æŸè€—æ¯”ä¾‹') && !document.getElementById('display-loss-gross-ratio').checked) {
              item.style.display = 'none';
            }
          });
        }
        
        // é”€å”®ç»“æœéƒ¨åˆ†
        const salesSection = resultSections[1];
        if (salesSection) {
          const salesItems = salesSection.querySelectorAll('.result-item');
          salesItems.forEach(item => {
            const text = item.querySelector('strong').textContent;
            item.style.display = 'block';
            if (text.includes('é”€å”®æ€»é¢') && !document.getElementById('display-sales-total').checked) {
              item.style.display = 'none';
            }
          });
        }
        
        // åˆ©æ¶¦åˆ†æéƒ¨åˆ†
        const profitSection = resultSections[2];
        if (profitSection) {
          const profitItems = profitSection.querySelectorAll('.result-item');
          profitItems.forEach(item => {
            const text = item.querySelector('strong').textContent;
            item.style.display = 'block';
            if (text.includes('é‡‡è´­æˆæœ¬') && !document.getElementById('display-profit-cost').checked) {
              item.style.display = 'none';
            }
            if (text.includes('åŠ å·¥è´¹ç”¨') && !document.getElementById('display-profit-fee').checked) {
              item.style.display = 'none';
            }
            if (text.includes('æ€»æˆæœ¬') && !document.getElementById('display-profit-total').checked) {
              item.style.display = 'none';
            }
            if (text.includes('é¢„ä¼°åˆ©æ¶¦') && !document.getElementById('display-profit-result').checked) {
              item.style.display = 'none';
            }
            if (text.includes('åˆ©æ¶¦ç‡') && !document.getElementById('display-profit-ratio').checked) {
              item.style.display = 'none';
            }
          });
        }
      }

      // åœ¨ IIFE ä¸­æ·»åŠ  copyResults å‡½æ•°å®šä¹‰
      window.copyResults = function() {
      // è·å–å½“å‰æ—¥æœŸ
      const now = new Date();
      const dateStr = now.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
        let copyText = '';
        
        // æ·»åŠ æ—¶é—´æˆ³
        if (document.getElementById('copy-timestamp').checked) {
          copyText += `${dateStr}\n\n`;
        }
        
        // è·å–è®¡ç®—ç±»å‹
        if (document.getElementById('copy-type').checked) {
          const calcType = document.getElementById('calculation-type').value;
          const typeText = {
            'loss': 'æŸè€—åˆ†æ',
            'sales': 'é”€å”®æ€»ä»·',
            'profit': 'åˆ©æ¶¦æ ¸ç®—'
          }[calcType];
          copyText += `${typeText}\n\n`;
        }
        
        // æ·»åŠ è¾“å…¥å‚æ•°
        if (document.getElementById('copy-input-params').checked) {
          const saleType = document.querySelector('input[name="sale-type"]:checked').value;
          const boxes = document.getElementById('boxes').value;
          const processedBoxes = document.getElementById('processed-boxes').value;
          const cleanWeight = document.getElementById('clean-weight').value;
          const price = document.getElementById('price').value;
          const fee = document.getElementById('fee').value;
          const boxCost = document.getElementById('box-cost').value;
          
          copyText += `${saleType === 'mud' ? 'æ³¥å§œ' : 'æ´—å§œ'}\n`;
          copyText += `å‡ºè´§ç®±æ•°: ${boxes}ç®±\n`;
          copyText += `å®é™…å‡ºè´§ä»¶æ•°: ${processedBoxes}ä»¶\n`;
          if (saleType === 'clean') {
            copyText += `æ´—å§œé‡é‡: ${cleanWeight}æ–¤\n`;
          }
          copyText += `å•ä»·: ${price}å…ƒ\n\n`;
        }
        
        // ç”¨äºè·Ÿè¸ªå·²å¤åˆ¶çš„å†…å®¹ï¼Œé¿å…é‡å¤
        const copiedContents = new Set();
        
        // è·å–æ‰€æœ‰ç»“æœé¡¹å¹¶å¤„ç†
        const resultSections = document.querySelectorAll('.result-section');
        resultSections.forEach(section => {
          const items = section.querySelectorAll('.result-item');
          items.forEach(item => {
            const titleEl = item.querySelector('strong');
            if (!titleEl) return;
            
            const title = titleEl.textContent;
            // è·å–å€¼ï¼ˆç›´æ¥è·å–strongæ ‡ç­¾åé¢çš„æ–‡æœ¬èŠ‚ç‚¹ï¼‰
            let value = '';
            let node = titleEl.nextSibling;
            while (node && node.nodeType === 3) { // æ–‡æœ¬èŠ‚ç‚¹
              value += node.textContent;
              node = node.nextSibling;
            }
            value = value.trim();
            
            // æ ¹æ®æ ‡é¢˜å’Œå¤é€‰æ¡†çŠ¶æ€å†³å®šæ˜¯å¦å¤åˆ¶
            const shouldCopy = (
              (title.includes('å‡€é‡é‡‡è´­é‡') && document.getElementById('copy-loss-net-purchase').checked) ||
              (title.includes('æ¯›é‡é‡‡è´­é‡') && document.getElementById('copy-loss-gross-purchase').checked) ||
              (title.includes('å®é™…å‡ºè´§é‡') && document.getElementById('copy-loss-actual').checked) ||
              (title.includes('å‡€é‡æŸè€—æ¯”ä¾‹') && document.getElementById('copy-loss-net-ratio').checked) ||
              (title.includes('æ¯›é‡æŸè€—æ¯”ä¾‹') && document.getElementById('copy-loss-gross-ratio').checked) ||
              (title.includes('é”€å”®æ€»é¢') && document.getElementById('copy-sales-total').checked) ||
              (title.includes('é‡‡è´­æˆæœ¬') && document.getElementById('copy-profit-cost').checked) ||
              (title.includes('åŠ å·¥è´¹ç”¨') && document.getElementById('copy-profit-fee').checked) ||
              (title.includes('æ€»æˆæœ¬') && document.getElementById('copy-profit-total').checked) ||
              (title.includes('é¢„ä¼°åˆ©æ¶¦') && document.getElementById('copy-profit-result').checked) ||
              (title.includes('åˆ©æ¶¦ç‡') && document.getElementById('copy-profit-ratio').checked)
            );
            
            // åªåœ¨å†…å®¹æœªè¢«å¤åˆ¶è¿‡ä¸”åº”è¯¥å¤åˆ¶æ—¶æ·»åŠ 
            const content = `${title}${value}`;
            if (shouldCopy && value && !copiedContents.has(content)) {
              copyText += `${content}\n`;
              copiedContents.add(content);
            }
          });
        });
        
        // å»é™¤å¤šä½™ç©ºè¡Œå¹¶æ•´ç†æ ¼å¼
        copyText = copyText.replace(/\n{3,}/g, '\n\n').trim();
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(copyText).then(() => {
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        const tip = document.createElement('div');
        tip.className = 'copy-success';
        tip.textContent = 'âœ“ å¤åˆ¶æˆåŠŸï¼';
        document.body.appendChild(tip);
        
        // 2ç§’åç§»é™¤æç¤º
        setTimeout(() => tip.remove(), 1500);

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        setTimeout(() => {
          document.getElementById('copy-btn').style.display = 'none';
          document.getElementById('calculate-btn').style.width = '100%';
        }, 3000);
      }).catch(err => {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å†…å®¹å¤åˆ¶');
      });
      }

      // ä¿ç•™è¿™ä¸ªå‡½æ•°ä½œä¸ºå”¯ä¸€çš„å†å²è®°å½•ä¿å­˜æ–¹æ³•
      window.saveCalculationHistory = function() {
        const calcType = inputStates["calculation-type"];
        const resultHTML = document.getElementById('result-content').innerHTML;
        
        // è·å–å½“å‰è¾“å…¥å€¼
        const inputValues = {
          boxes: document.getElementById('boxes').value,
          'processed-boxes': document.getElementById('processed-boxes').value,
          'clean-weight': document.getElementById('clean-weight').value,
          price: document.getElementById('price').value,
          fee: document.getElementById('fee').value,
          'box-cost': document.getElementById('box-cost').value,
          'sale-type': document.querySelector('input[name="sale-type"]:checked').value,
        };
        
        // ç”Ÿæˆè¾“å…¥å€¼çš„HTML
        const inputsHTML = `
          <div class="inputs-summary">
            <strong>è¾“å…¥å‚æ•°ï¼š</strong><br>
            ${inputValues['sale-type'] === 'mud' ? 'æ³¥å§œ' : 'æ´—å§œ'}<br>
            å‡ºè´§ç®±æ•°: ${inputValues.boxes}ç®±<br>
            å®é™…å‡ºè´§ä»¶æ•°: ${inputValues['processed-boxes']}ä»¶<br>
            ${inputValues['sale-type'] === 'clean' ? `æ´—å§œé‡é‡: ${inputValues['clean-weight']}æ–¤<br>` : ''}
            å•ä»·: ${inputValues.price}å…ƒ
          </div>
        `;
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = resultHTML;
        
        // ç§»é™¤æ‰€æœ‰è®¡ç®—å…¬å¼
        tempDiv.querySelectorAll('.formula-hint').forEach(el => el.remove());
        
        // å°†è¾“å…¥å€¼æ·»åŠ åˆ°ç»“æœHTMLçš„å¼€å¤´
        tempDiv.insertAdjacentHTML('afterbegin', inputsHTML);
        
        // è·å–å¤„ç†åçš„ HTML
        const cleanResult = tempDiv.innerHTML;
        
        // è·å–ç°æœ‰å†å²è®°å½•
        const historyRecords = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
        
        // æ·»åŠ æ–°è®°å½•
        historyRecords.unshift({
          id: Date.now().toString(),
          timestamp: new Date().toISOString(),
          type: calcType,
          result: cleanResult,
          inputValues,
          note: ''
        });
        
        localStorage.setItem('calculationHistory', JSON.stringify(historyRecords));
      }

      // åˆå§‹åŒ–é¡µé¢
      function initPage() {
        // å…ˆåŠ è½½è®¾ç½®
        loadCurrentSettings();
        
        // åŠ è½½ä¸Šæ¬¡è¾“å…¥å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
        const lastInputValues = localStorage.getItem('lastInputValues');
        if (lastInputValues) {
          const savedInputs = JSON.parse(lastInputValues);
          Object.keys(savedInputs).forEach(key => {
            inputStates[key] = savedInputs[key];
          });
        }
        
        // æ¢å¤è¾“å…¥å€¼åˆ°ç•Œé¢
        restoreInputValues();
        
        // æ›´æ–°UI
        updateUI();
        
        // å¦‚æœæœ‰è®¡ç®—ç»“æœï¼Œé‡æ–°è®¡ç®—
        if (document.getElementById('result-area') && !document.getElementById('result-area').classList.contains('hidden')) {
          calculate();
        }
      }

      // IIFE åˆå§‹åŒ–éƒ¨åˆ†
      document.addEventListener('DOMContentLoaded', function() {
        initPage();
      });
    })();

    // å°† switchSettingsTab å‡½æ•°ç§»åˆ° IIFE å¤–éƒ¨
    window.switchSettingsTab = function(tabName) {
      // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.tab-btn[onclick*="${tabName}"]`).classList.add('active');
      
      // æ›´æ–°è®¾ç½®åŒºåŸŸæ˜¾ç¤º
      document.querySelectorAll('.settings-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${tabName}-settings`).classList.add('active');
    }
  </script>
</body>
</html>